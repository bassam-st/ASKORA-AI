<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ASKORA AI (Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:#0f0f14; color:#fff;
      margin:0; padding:20px;
    }
    h1 { text-align:center; margin:0 0 16px; }

    .container {
      max-width:700px; margin:auto; background:#161622;
      padding:18px; border-radius:12px; box-shadow:0 0 30px rgba(0,0,0,.4);
    }

    textarea {
      width:100%; min-height:120px; padding:12px;
      border-radius:10px; border:none; resize:vertical;
      font-size:16px; box-sizing:border-box;
    }

    button {
      margin-top:10px; padding:10px 18px; font-size:16px;
      border-radius:10px; border:none; cursor:pointer;
      background:#7c3aed; color:#fff;
    }
    button:disabled { opacity:0.6; cursor:not-allowed; }

    /* صندوق عام للنتائج */
    .panel {
      margin-top:14px;
      background:#0b0b12;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden; /* مهم: يمنع خروج أي شيء */
    }

    .panel h3 {
      margin:0;
      padding:10px 12px;
      font-size:14px;
      opacity:.9;
      background:rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    .panel .content {
      padding:12px;
      line-height:1.8;
      white-space:pre-wrap;
      overflow-wrap:anywhere; /* مهم للروابط الطويلة */
      word-break:break-word;  /* مهم للروابط الطويلة */
    }

    .error {
      margin-top:16px; padding:12px;
      background:#2b0b0b; color:#ffb4b4;
      border-radius:10px; font-family:monospace;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .note {
      margin-top:10px; font-size:13px; opacity:0.85;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    /* صندوق المصادر */
    .sourcesList {
      list-style:none;
      padding:10px 12px;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .srcItem {
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:10px;
      padding:10px;
      overflow:hidden; /* يمنع خروج النص */
    }

    .srcTitle {
      font-size:14px;
      margin:0 0 6px;
      opacity:.95;
    }

    .srcLink {
      display:block;
      font-size:13px;
      color:#9ca3ff;
      text-decoration:none;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .srcLink:hover { text-decoration:underline; }

    .loading {
      margin-top:14px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <h1>ASKORA AI (Test)</h1>

  <div class="container">
    <textarea id="question" placeholder="اكتب سؤالك هنا..."></textarea>
    <br />
    <button id="askBtn">إرسال</button>
    <div id="result"></div>
  </div>

<script>
  const btn = document.getElementById("askBtn");
  const questionInput = document.getElementById("question");
  const resultDiv = document.getElementById("result");

  btn.onclick = async () => {
    const question = questionInput.value.trim();
    if (!question) return;

    btn.disabled = true;
    resultDiv.innerHTML = `<div class="loading">⏳ جاري التفكير...</div>`;

    try {
      const res = await fetch("/api/askora", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });

      const data = await res.json();

      if (!data || data.ok !== true) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : "خطأ غير معروف";
        resultDiv.innerHTML = `<div class="error">${escapeHtml(msg)}</div>`;
        return;
      }

      const answerText = (data.answer ?? "").toString();
      const noteText = data.note ? String(data.note) : "";

      // ✅ مصفوفة مصادر آمنة
      const sourcesArr = Array.isArray(data.sources) ? data.sources : [];
      const sourcesTop = sourcesArr.slice(0, 5);

      // 1) صندوق الملخص
      let html = `
        <div class="panel">
          <h3>الملخص</h3>
          <div class="content">${escapeHtml(answerText)}</div>
        </div>
      `;

      // 2) ملاحظة
      if (noteText) {
        html += `<div class="note">ℹ️ ${escapeHtml(noteText)}</div>`;
      }

      // 3) صندوق المصادر (مرتب + روابط قابلة للنقر)
      if (sourcesTop.length > 0) {
        html += `
          <div class="panel" style="margin-top:12px;">
            <h3>المصادر</h3>
            <ul class="sourcesList">
              ${sourcesTop.map((s, i) => {
                const title = (s && s.title) ? String(s.title) : `مصدر ${i+1}`;
                const link  = (s && (s.link || s.url)) ? String(s.link || s.url) : "";
                return `
                  <li class="srcItem">
                    <p class="srcTitle">${escapeHtml(title)}</p>
                    ${link ? `<a class="srcLink" href="${escapeAttr(link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link)}</a>` : `<span class="srcLink" style="opacity:.6">بدون رابط</span>`}
                  </li>
                `;
              }).join("")}
            </ul>
          </div>
        `;
      }

      resultDiv.innerHTML = html;

    } catch (err) {
      resultDiv.innerHTML = `<div class="error">${escapeHtml(err.message || String(err))}</div>`;
    } finally {
      btn.disabled = false;
    }
  };

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function escapeAttr(str) {
    // نفس escapeHtml لكن مناسب للـ attribute
    return escapeHtml(str).replaceAll("`", "&#096;");
  }
</script>
</body>
</html>

