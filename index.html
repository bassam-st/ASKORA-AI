<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASKORA AI (Test)</title>
  <style>
    :root{
      --bg:#0b0b12; --card:#12122a; --card2:#0f1020;
      --txt:#e7e7f0; --muted:#a9a9c2;
      --border:rgba(255,255,255,.08);
      --purple:#7c3aed; --purple2:#6d28d9;
      --btn:#1b1c35;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
      background: radial-gradient(1200px 600px at 50% 0%, rgba(124,58,237,.22), transparent 60%), var(--bg);
      color:var(--txt);
      min-height:100vh;
      display:flex; justify-content:center; align-items:flex-start;
      padding:28px 14px;
    }
    .wrap{width:min(720px, 100%);}
    h1{margin:8px 0 18px; text-align:center; letter-spacing:.5px; font-size:28px;}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:22px;
      padding:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.45);
    }
    textarea{
      width:100%; min-height:110px; resize:vertical;
      border-radius:18px; border:1px solid var(--border);
      background:#fff; color:#111; padding:14px; font-size:18px;
      outline:none;
    }
    .row{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; align-items:center;}
    .btn{
      border:1px solid var(--border);
      background:var(--btn); color:var(--txt);
      padding:12px 16px; border-radius:14px;
      font-size:16px; cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(180deg, var(--purple), var(--purple2));
      border-color:rgba(124,58,237,.55);
      min-width:120px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .pill{
      margin-inline-start:auto;
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      border:1px solid var(--border); background:rgba(255,255,255,.03);
      color:var(--muted); font-size:14px;
    }
    .dot{width:10px;height:10px;border-radius:50%; background:#22c55e}
    .meta{
      margin-top:12px;
      color:var(--muted); font-size:14px;
      border:1px solid var(--border); background:rgba(255,255,255,.03);
      padding:10px 12px; border-radius:999px;
    }

    .card{
      margin-top:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:20px;
      padding:14px;
    }
    .card h3{margin:0 0 10px; font-size:18px; color:#ddd;}
    .answer{
      white-space:pre-wrap;
      line-height:1.85;
      font-size:16px;
      color:#f0f0ff;
    }
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
    }
    .actions a{
      text-decoration:none;
    }
    .actionBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      min-width:160px;
    }
    .actionBtn.primary{
      background:linear-gradient(180deg, rgba(124,58,237,.9), rgba(109,40,217,.9));
      border-color:rgba(124,58,237,.55);
    }

    .src{
      margin-top:10px;
      border-top:1px dashed rgba(255,255,255,.12);
      padding-top:10px;
      color:var(--muted);
      font-size:14px;
    }
    .src a{color:#9aa7ff}
    label.chk{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px;}
    input[type="checkbox"]{transform:scale(1.15)}
    .err{
      margin-top:12px;
      background:rgba(220,38,38,.16);
      border:1px solid rgba(220,38,38,.35);
      padding:12px 14px;
      border-radius:16px;
      color:#ffd1d1;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ASKORA AI (Test)</h1>

    <div class="panel">
      <textarea id="q" placeholder="اكتب سؤالك هنا..."></textarea>

      <div class="row">
        <button class="btn primary" id="send">إرسال!</button>
        <button class="btn" id="copy">نسخ الملخص</button>
        <button class="btn" id="clear">مسح</button>

        <label class="chk">
          <input type="checkbox" id="autoOpen" checked />
          فتح تلقائي لروابط المباريات
        </label>

        <div class="pill"><span class="dot" id="dot"></span><span id="st">جاهز</span></div>
      </div>

      <div class="meta" id="note">—</div>

      <div id="out"></div>
      <div id="err" class="err" style="display:none;"></div>
    </div>
  </div>

  <script type="module">
    const $ = (id)=>document.getElementById(id);

    const q = $("q");
    const send = $("send");
    const copy = $("copy");
    const clear = $("clear");
    const out = $("out");
    const err = $("err");
    const st = $("st");
    const dot = $("dot");
    const note = $("note");
    const autoOpen = $("autoOpen");

    let lastAnswerText = "";

    function setStatus(ok, text){
      st.textContent = text || (ok ? "تم" : "خطأ");
      dot.style.background = ok ? "#22c55e" : "#ef4444";
    }

    function renderResponse(data){
      out.innerHTML = "";
      err.style.display = "none";

      const intent = data?.intent || "general";
      const actions = Array.isArray(data?.actions) ? data.actions : [];
      const sources = Array.isArray(data?.sources) ? data.sources : [];
      const answer = String(data?.answer || "").trim();
      lastAnswerText = answer;

      // Card: Answer + Actions
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3>الملخص <span style="color:#9ca3af;font-size:13px;">intent: ${intent}</span></h3>
        <div class="answer">${escapeHtml(answer)}</div>
      `;

      if (actions.length){
        const aWrap = document.createElement("div");
        aWrap.className = "actions";

        actions.forEach((a)=>{
          const url = String(a?.url || "").trim();
          const label = String(a?.label || "فتح").trim();
          if (!url) return;

          const link = document.createElement("a");
          link.href = url;
          link.target = "_blank";
          link.rel = "noopener";

          const btn = document.createElement("div");
          btn.className = "actionBtn" + (a?.primary ? " primary" : "");
          btn.textContent = label;

          link.appendChild(btn);
          aWrap.appendChild(link);
        });

        card.appendChild(aWrap);
      }

      if (sources.length){
        const s = document.createElement("div");
        s.className = "src";
        s.innerHTML = `<div style="margin-bottom:6px;color:#d1d5db;">المصادر (${sources.length})</div>`;
        sources.slice(0,6).forEach((x)=>{
          const t = escapeHtml(String(x?.title || "مصدر").trim() || "مصدر");
          const u = String(x?.link || "").trim();
          if (u){
            const p = document.createElement("div");
            p.innerHTML = `• <a href="${u}" target="_blank" rel="noopener">${t}</a>`;
            s.appendChild(p);
          }
        });
        card.appendChild(s);
      }

      out.appendChild(card);
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    async function ask(){
      const text = q.value.trim();
      if (!text) return;

      setStatus(true, "جارٍ...");
      note.textContent = "—";
      err.style.display = "none";
      out.innerHTML = "";

      // ✅ Trick لفتح تبويب بدون ما يمنعه المتصفح (بما أنه من click)
      let pendingWin = null;
      if (autoOpen.checked) {
        pendingWin = window.open("", "_blank");
      }

      send.disabled = true;

      try{
        const res = await fetch("/api/askora", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ question: text })
        });

        // لو صار رد غير JSON
        const raw = await res.text();
        let data = null;
        try { data = JSON.parse(raw); }
        catch(e){
          throw new Error("الرد ليس JSON:\n" + raw.slice(0, 200));
        }

        note.textContent = String(data?.note || "—");

        if (!data?.ok){
          setStatus(false, "خطأ");
          err.style.display = "block";
          err.textContent = (data?.message || data?.error || "Server error");
          if (pendingWin) pendingWin.close();
          return;
        }

        setStatus(true, "تم");
        renderResponse(data);

        // ✅ فتح تلقائي: لو فيه Action primary + autofire
        const actions = Array.isArray(data?.actions) ? data.actions : [];
        const fire = actions.find(a => a?.primary && a?.autofire && a?.url);

        if (pendingWin) {
          if (fire?.url) pendingWin.location = fire.url;
          else pendingWin.close();
        }

      }catch(e){
        setStatus(false, "خطأ");
        err.style.display = "block";
        err.textContent = String(e?.message || e || "error");
        if (pendingWin) pendingWin.close();
      }finally{
        send.disabled = false;
      }
    }

    send.addEventListener("click", ask);
    q.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        ask();
      }
    });

    copy.addEventListener("click", async ()=>{
      if (!lastAnswerText) return;
      try{
        await navigator.clipboard.writeText(lastAnswerText);
        note.textContent = "✅ تم نسخ الملخص";
      }catch{
        note.textContent = "تعذر النسخ";
      }
    });

    clear.addEventListener("click", ()=>{
      q.value = "";
      out.innerHTML = "";
      err.style.display = "none";
      note.textContent = "—";
      setStatus(true, "جاهز");
    });
  </script>
</body>
</html>
